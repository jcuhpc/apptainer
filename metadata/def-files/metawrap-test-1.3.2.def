Bootstrap: localimage
From: /gpfs01/Q0195/containers/ubuntu-22.04.sif

%runscript
exec "$@"

%post
cd /opt
apt update
apt install -y libarchive-dev libarchive-tools
install -d -m 2775 -o root -g root /gpfs01
install -d -m 1777 -o root -g root /scratch /fast/tmp
wget https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh
bash Miniconda2-latest-Linux-x86_64.sh -b -p /opt/conda
rm -f Miniconda2-latest-Linux-x86_64.sh
export PATH="/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
git clone https://github.com/bxlab/metaWRAP.git
conda install -c conda-forge mamba 
mamba install python=2.7
#conda activate metawrap-env
conda config --add channels defaults
conda config --add channels conda-forge
conda config --add channels bioconda
#conda config --add channels ursky
#conda install --only-deps -c ursky metawrap-mg
mamba install biopython blas=2.5 blast=2.6.0 bmtagger bowtie2 bwa checkm-genome fastqc krona=2.7 matplotlib maxbin2 megahit metabat2 pandas prokka quast r-ggplot2 r-recommended salmon samtools=1.9 seaborn spades trim-galore
mamba install kraken=1.1.1 kraken=2.1.3
mamba install concoct=1.0 pplacer
. /opt/conda/etc/profile.d/conda.sh

%environment
    export PATH="/opt/metaWRAP/bin:/opt/conda/envs/metawrap-env/bin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    export bin_path=/opt/conda/envs/metawrap-mg/bin
    export mw_path=/opt/conda/envs/metawrap-mg/bin/metawrap
    export SOFT=/opt/conda/envs/metawrap-mg/bin/metawrap-scripts
    export PIPES=/opt/conda/envs/metawrap-mg/bin/metawrap-modules
    export KRAKEN_DB=/scratch/database/kracken
    export KRAKEN2_DB=/scratch/database/kraken2
    export BMTAGGER_DB=/scratch/database/bmtagger
    export BLASTDB=/scratch/database/blast4/nt
    export TAXDUMP=/scratch/database/taxdump
    export CONDA_HOME=/opt/conda
    export CONDA_PROF=/opt/conda/etc/profile.d

